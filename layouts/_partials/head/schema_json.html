{{- $brandingImgs := partialCached "_funcs/get-branding-assets.html" . }}

{{- if .IsHome }}
    <script type="application/ld+json">
        {
        "@context"     : "https://schema.org",
        "@type"        : "{{- (site.Params.neso.seo.schema.publisher_type | default "Person") | title -}}",
        "name"         : {{ site.Title }},
        "url"          : {{ site.Home.Permalink }},
        "description"  : {{ site.Params.neso.seo.site_description
            | default site.Params.description
            | default .Description
            | plainify | strings.TrimSpace | truncate 180 }},

        {{- if (eq site.Params.neso.seo.schema.publisher_type "Organization") }}
        "logo"         : {{ index $brandingImgs "logo_image"
            | default (index $brandingImgs "favicon_svg")
            | default (index $brandingImgs "favicon_ico")
            | absURL }},

        {{- else }}
        "image"        : {{ index $brandingImgs "logo_image"
            | default (index $brandingImgs "favicon_svg")
            | default (index $brandingImgs "favicon_ico")
            | absURL }},

        {{- end }}
        "sameAs"       :
            [
            {{- if site.Params.neso.seo.schema.same_as }}
            {{ range $i, $e := site.Params.neso.seo.schema.same_as -}}
            {{- if $i -}},
            {{ end -}}
            {{- trim $e " " }}
            {{- end -}}
            {{- else }}
            {{ range $i, $e := site.Params.neso.social.links -}}
            {{- if $i -}},
            {{ end -}}
            {{- trim $e.url " " | safeURL }}
            {{- end -}}
            {{- end }}
            ]
        }
    </script>

{{- else if (or .IsPage .IsSection (in (slice "taxonomy" "term") .Kind)) }}

    {{- $anc := .Ancestors }}
    {{- $anc = $anc.Reverse }}
    {{- $ancNoHome := where $anc "IsHome" false }}

    {{- /* Breadcrumb List */}}
    <script type="application/ld+json">
        {
        "@context"             : "https://schema.org",
        "@type"                : "BreadcrumbList",
        "itemListElement"      :
            [
            {{- range $i, $p := $ancNoHome }}
            {{- if $i -}},
            {{ end -}}
            {
            "@type"            : "ListItem",
            "position"         : {{- add 1 $i -}},
            "name"             : {{ $p.Title | default $p.Name }},
            "item"             : {{ $p.Permalink | safeHTML }}
            }
            {{- end -}}
            {{- /* self-page addition (last item) */ -}}
            {{- if gt (len $ancNoHome) 0 -}},
            {{ end -}}
            {
            "@type"            : "ListItem",
            "position"         : {{- add (len $ancNoHome) 1 -}},
            "name"             : {{ .Title | default .Name }},
            "item"             : {{ .Permalink | safeHTML }}
            }]
        }
    </script>

    {{- if .IsPage }}
    <script type="application/ld+json">
        {
        "@context"             : "https://schema.org",
        "@type"                : "BlogPosting",
        "headline"             : {{ .Title | plainify }},
        "name"                 : {{ .Title | plainify }},
        "description"          : {{ with .Description | plainify | strings.TrimSpace }}{{ . }}{{ else }}{{ .Summary | plainify | strings.TrimSpace }}{{ end -}},
        "keywords"             : [
            {{- if .Params.keywords -}}
            {{- range $i, $e := .Params.keywords -}}{{- if $i -}}, {{ end -}}{{- $e -}}{{- end -}}
            {{- else -}}
            {{- range $i, $e := .Params.tags -}}{{- if $i -}}, {{ end -}}{{- $e -}}{{- end -}}
            {{- end -}}
        ],
        "articleBody"          : {{ .Content | safeJS | htmlUnescape | plainify }},
        "wordCount"            : "{{ .WordCount }}",
        "inLanguage"           : {{ .Language.Lang | default "en-US" }},
        {{- $images := partial "_funcs/get-page-images" . -}}
        {{- with index $images 0 }}
        "image"                : {{ .Permalink }},
        {{- end }}
        "datePublished"        : {{ .PublishDate }},
        "dateModified"         : {{ .Lastmod }},
        {{- $authors := partial "_funcs/get-author.html" . -}}
        {{- if gt (len $authors) 0 }}
        "author"               :
            {{- if gt (len $authors) 1 }}
            [
            {{- range $i, $name := $authors }}
            {{- if $i -}}, 
            {{ end -}}
            {
            "@type"            : "Person",
            "name"             : {{ $name }}
            }
            {{- end -}}
            ],
            {{- else }}
            {
            "@type"            : "Person",
            "name"             : {{ index $authors 0 }}
            },
            {{- end -}}
        {{- end }}
        "mainEntityOfPage"     :
            {
            "@type"            : "WebPage",
            "@id"              : {{ .Permalink | safeHTML }}
            },
        "publisher"            :
            {
            "@type"            : "{{- (site.Params.neso.seo.schema.publisher_type | default "Person") | title -}}",
            "name"             : {{ site.Title }},
            "logo"             :
                {
                "@type"        : "ImageObject",
                "url"          : {{ index $brandingImgs "logo_image"
                    | default (index $brandingImgs "favicon_svg")
                    | default (index $brandingImgs "favicon_ico")
                    | absURL }}
                }
            }
        }
    </script>
    {{- end }}

{{- end -}}
